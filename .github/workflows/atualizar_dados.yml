name: üîÑ Atualizar Dados do Google Sheet

on:
  schedule:
    # Executa diariamente √†s 9h UTC (6h no hor√°rio de Bras√≠lia)
    - cron: '0 9 * * *'
  # Permite a execu√ß√£o manual
  workflow_dispatch:

# Permiss√µes necess√°rias para criar PRs
permissions:
  contents: write
  pull-requests: write

jobs:
  atualizar:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Clonar reposit√≥rio
        uses: actions/checkout@v4
        with:
          # Token necess√°rio para autenticar as a√ß√µes de commit/PR
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Instalar depend√™ncias Python
        run: |
          python -m pip install --upgrade pip
          pip install gspread oauth2client

      - name: üîë Configurar credenciais Google
        # Cria o arquivo 'credentials.json' usando o Secret do reposit√≥rio
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json

      - name: ‚ñ∂Ô∏è Executar script (Buscar dados e gerar HTML)
        # Esta etapa executa o script Python que criar√° o 'index.html'
        run: python atualizar_dados.py

      - name: ‚ûï Criar Pull Request com o HTML atualizado
        # Esta a√ß√£o verifica se o 'index.html' mudou.
        # Se mudou, ela faz o commit e abre um PR automaticamente.
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ü§ñ [Bot] Atualiza index.html com dados da planilha"
          title: "ü§ñ Atualiza√ß√£o de Dados: $(date +%Y-%m-%d)"
          body: |
            Este PR foi aberto automaticamente.
            
            O script `atualizar_dados.py` buscou novos dados da planilha "Dados"
            e gerou o novo `index.html`.
            
            **Por favor, revise as altera√ß√µes antes de fazer o merge.**
          
          # Define o nome do branch (sempre o mesmo, para atualizar o PR existente)
          branch: "feat/atualizacao-dados-automatica" 
          # Define o branch alvo
          base: main
          # Deleta o branch ap√≥s o merge
          delete-branch: true
